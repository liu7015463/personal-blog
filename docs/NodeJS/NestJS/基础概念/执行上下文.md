# æ‰§è¡Œä¸Šä¸‹æ–‡
Nest æä¾›äº†å¤šä¸ªå®ç”¨å·¥å…·ç±»ï¼Œå¸®åŠ©å¼€å‘è€…è½»æ¾ç¼–å†™èƒ½åœ¨å¤šç§åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚åŸºäº Nest HTTP æœåŠ¡å™¨çš„åº”ç”¨ã€å¾®æœåŠ¡åŠ WebSockets åº”ç”¨ç­‰ä¸åŒä¸Šä¸‹æ–‡ç¯å¢ƒï¼‰ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚è¿™äº›å·¥å…·èƒ½è·å–å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œç”¨äºæ„å»ºé€šç”¨çš„å®ˆå«ã€è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨ï¼Œä½¿å…¶èƒ½å¤Ÿè·¨å¤šç§æ§åˆ¶å™¨ã€æ–¹æ³•åŠæ‰§è¡Œä¸Šä¸‹æ–‡å·¥ä½œã€‚
æœ¬ç« æˆ‘ä»¬å°†ä»‹ç»ä¸¤ä¸ªè¿™æ ·çš„ç±»ï¼šÂ `ArgumentsHost`Â å’ŒÂ `ExecutionContext`Â ã€‚

# ArgumentsHost ç±»
`ArgumentsHost`Â ç±»æä¾›äº†æ£€ç´¢ä¼ é€’ç»™å¤„ç†ç¨‹åºçš„å‚æ•°çš„æ–¹æ³•ã€‚å®ƒå…è®¸é€‰æ‹©åˆé€‚çš„ä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚ HTTPã€RPCï¼ˆå¾®æœåŠ¡ï¼‰æˆ– WebSocketsï¼‰æ¥è·å–å‚æ•°ã€‚æ¡†æ¶ä¼šåœ¨æ‚¨å¯èƒ½éœ€è¦è®¿é—®çš„åœ°æ–¹æä¾›ä¸€ä¸ªÂ `ArgumentsHost`Â å®ä¾‹ï¼Œé€šå¸¸ä½œä¸ºÂ `host`Â å‚æ•°å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œ[å¼‚å¸¸è¿‡æ»¤å™¨](/NodeJS/NestJS/æ¦‚è¿°/å¼‚å¸¸è¿‡æ»¤å™¨.md)çš„ `catch()` æ–¹æ³•ä¼šé€šè¿‡ä¼ å…¥ `ArgumentsHost` å®ä¾‹æ¥è°ƒç”¨ã€‚

```TS
export interface ArgumentsHost {
  /**
   * Returns the array of arguments being passed to the handler.
   */
  getArgs<T extends Array<any> = any[]>(): T;
  /**
   * Returns a particular argument by index.
   * @param index index of argument to retrieve
   */
  getArgByIndex<T = any>(index: number): T;
  /**
   * Switch context to RPC.
   * @returns interface with methods to retrieve RPC arguments
   */
  switchToRpc(): RpcArgumentsHost;
  /**
   * Switch context to HTTP.
   * @returns interface with methods to retrieve HTTP arguments
   */
  switchToHttp(): HttpArgumentsHost;
  /**
   * Switch context to WebSockets.
   * @returns interface with methods to retrieve WebSockets arguments
   */
  switchToWs(): WsArgumentsHost;
  /**
   * Returns the current execution context type (string)
   */
  getType<TContext extends string = ContextType>(): TContext;
}
```
`ArgumentsHost`Â æœ¬è´¨ä¸Šæ˜¯å¯¹å¤„ç†ç¨‹åºå‚æ•°çš„æŠ½è±¡å°è£…ã€‚ä»¥ HTTP æœåŠ¡å™¨åº”ç”¨ä¸ºä¾‹ï¼ˆå½“ä½¿ç”¨Â `@nestjs/platform-express`Â æ—¶ï¼‰ï¼ŒÂ `host`Â å¯¹è±¡å°è£…äº† Express æ¡†æ¶çš„Â `[request, response, next]`Â æ•°ç»„ï¼Œå…¶ä¸­Â `request`Â æ˜¯è¯·æ±‚å¯¹è±¡ï¼ŒÂ `response`Â æ˜¯å“åº”å¯¹è±¡ï¼ŒÂ `next`Â æ˜¯æ§åˆ¶åº”ç”¨è¯·æ±‚-å“åº”å‘¨æœŸçš„å‡½æ•°ã€‚è€Œå¯¹äº GraphQL åº”ç”¨ï¼ŒÂ `host`Â å¯¹è±¡åˆ™åŒ…å«Â `[root, args, context, info]`Â æ•°ç»„ã€‚

# å½“å‰åº”ç”¨ä¸Šä¸‹æ–‡
åœ¨æ„å»ºéœ€è¦è·¨å¤šä¸ªåº”ç”¨ä¸Šä¸‹æ–‡è¿è¡Œçš„é€šç”¨[å®ˆå«](/NodeJS/NestJS/æ¦‚è¿°/å®ˆå«.md)ã€[è¿‡æ»¤å™¨](/NodeJS/NestJS/æ¦‚è¿°/å¼‚å¸¸è¿‡æ»¤å™¨.md)å’Œ[æ‹¦æˆªå™¨](https://docs.nestjs.com/interceptors)æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šå½“å‰æ–¹æ³•è¿è¡Œåœ¨å“ªç§ç±»å‹çš„åº”ç”¨ä¸­ã€‚å¯ä»¥é€šè¿‡ `ArgumentsHost` çš„ `getType()` æ–¹æ³•å®ç°ï¼š

```typescript
if (host.getType() === 'http') {
  // do something that is only important in the context of regular HTTP requests (REST)
} else if (host.getType() === 'rpc') {
  // do something that is only important in the context of Microservice requests
} else if (host.getType<GqlContextType>() === 'graphql') {
  // do something that is only important in the context of GraphQL requests
}
```

>ğŸ“Œæç¤º
>`GqlContextType`Â éœ€ä»Â `@nestjs/graphql`Â åŒ…ä¸­å¯¼å…¥

é€šè¿‡è·å–åº”ç”¨ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™æ›´é€šç”¨çš„ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

# å®¿ä¸»å¤„ç†å™¨å‚æ•°
è¦è·å–ä¼ é€’ç»™å¤„ç†å™¨çš„å‚æ•°æ•°ç»„ï¼Œä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨å®¿ä¸»å¯¹è±¡çš„Â `getArgs()`Â æ–¹æ³•ã€‚

```typescript
const [req, res, next] = host.getArgs();
```
æ‚¨å¯ä»¥é€šè¿‡ç´¢å¼•ä½¿ç”¨Â `getArgByIndex()`Â æ–¹æ³•æå–ç‰¹å®šå‚æ•°ï¼š
```typescript
const request = host.getArgByIndex(0);
const response = host.getArgByIndex(1);
```
åœ¨è¿™äº›ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç´¢å¼•è·å–äº†è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œè¿™ç§æ–¹å¼é€šå¸¸ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¼šå°†åº”ç”¨ç¨‹åºä¸ç‰¹å®šçš„æ‰§è¡Œä¸Šä¸‹æ–‡è€¦åˆã€‚ç›¸åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Â `host`Â å¯¹è±¡çš„å®ç”¨æ–¹æ³•ä¹‹ä¸€æ¥åˆ‡æ¢åˆ°é€‚åˆæ‚¨åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œä½¿ä»£ç æ›´åŠ å¥å£®å’Œå¯é‡ç”¨ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢å®ç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚
```typescript
/**
 * Switch context to RPC.
 */
switchToRpc(): RpcArgumentsHost;
/**
 * Switch context to HTTP.
 */
switchToHttp(): HttpArgumentsHost;
/**
 * Switch context to WebSockets.
 */
switchToWs(): WsArgumentsHost;
```
è®©æˆ‘ä»¬ä½¿ç”¨Â `switchToHttp()`Â æ–¹æ³•é‡å†™å‰é¢çš„ç¤ºä¾‹ã€‚Â `host.switchToHttp()`Â è¾…åŠ©è°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªé€‚ç”¨äº HTTP åº”ç”¨ä¸Šä¸‹æ–‡çš„Â `HttpArgumentsHost`Â å¯¹è±¡ã€‚è¯¥Â `HttpArgumentsHost`Â å¯¹è±¡æœ‰ä¸¤ä¸ªå®ç”¨æ–¹æ³•å¯ç”¨äºæå–æ‰€éœ€å¯¹è±¡ã€‚æœ¬ä¾‹ä¸­æˆ‘ä»¬è¿˜ä½¿ç”¨äº† Express ç±»å‹æ–­è¨€æ¥è¿”å›åŸç”Ÿ Express ç±»å‹çš„å¯¹è±¡ï¼š
```typescript
const ctx = host.switchToHttp();
const request = ctx.getRequest<Request>();
const response = ctx.getResponse<Response>();
```
ç±»ä¼¼åœ°ï¼ŒÂ `WsArgumentsHost`Â å’ŒÂ `RpcArgumentsHost`Â ä¹Ÿæä¾›äº†åœ¨å¾®æœåŠ¡å’Œ WebSocket ä¸Šä¸‹æ–‡ä¸­è¿”å›ç›¸åº”å¯¹è±¡çš„æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯Â `WsArgumentsHost`Â çš„æ–¹æ³•ï¼š
```typescript
export interface WsArgumentsHost {
  /**
   * Returns the data object.
   */
  getData<T>(): T;
  /**
   * Returns the client object.
   */
  getClient<T>(): T;
}
```
ä»¥ä¸‹æ˜¯Â `RpcArgumentsHost`Â çš„æ–¹æ³•ï¼š
```typescript
export interface RpcArgumentsHost {
  /**
   * Returns the data object.
   */
  getData<T>(): T;

  /**
   * Returns the context object.
   */
  getContext<T>(): T;
}
```

# ExecutionContext ç±»
`ExecutionContext` ç»§æ‰¿è‡ª `ArgumentsHost` ï¼Œæä¾›äº†å…³äºå½“å‰æ‰§è¡Œè¿‡ç¨‹çš„é¢å¤–ç»†èŠ‚ã€‚ä¸ `ArgumentsHost` ç±»ä¼¼ï¼ŒNest ä¼šåœ¨ä½ å¯èƒ½éœ€è¦çš„åœ°æ–¹æä¾› `ExecutionContext` çš„å®ä¾‹ï¼Œä¾‹å¦‚[å®ˆå«](/NodeJS/NestJS/æ¦‚è¿°/å®ˆå«.md)çš„ `canActivate()` æ–¹æ³•å’Œ[æ‹¦æˆªå™¨](https://docs.nestjs.com/interceptors)çš„ `intercept()` æ–¹æ³•ã€‚å®ƒæä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼š
```typescript
export interface ExecutionContext extends ArgumentsHost {
  /**
   * Returns the type of the controller class which the current handler belongs to.
   */
  getClass<T>(): Type<T>;
  /**
   * Returns a reference to the handler (method) that will be invoked next in the
   * request pipeline.
   */
  getHandler(): Function;
}
```
`getHandler()`Â æ–¹æ³•è¿”å›å³å°†è¢«è°ƒç”¨çš„å¤„ç†ç¨‹åºçš„å¼•ç”¨ã€‚Â `getClass()`Â æ–¹æ³•è¿”å›è¯¥ç‰¹å®šå¤„ç†ç¨‹åºæ‰€å±çš„Â `Controller`Â ç±»çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œåœ¨ HTTP ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚æœå½“å‰å¤„ç†çš„è¯·æ±‚æ˜¯Â `POST`Â è¯·æ±‚ï¼Œç»‘å®šåˆ°Â `CatsController`Â ä¸Šçš„Â `create()`Â æ–¹æ³•ï¼ŒÂ `getHandler()`Â ä¼šè¿”å›Â `create()`Â æ–¹æ³•çš„å¼•ç”¨ï¼Œè€ŒÂ `getClass()`Â ä¼šè¿”å›Â `CatsController`Â ç±»ï¼ˆéå®ä¾‹ï¼‰ã€‚
```typescript
const methodKey = ctx.getHandler().name; // "create"
const className = ctx.getClass().name; // "CatsController"
```
èƒ½å¤ŸåŒæ—¶è®¿é—®å½“å‰ç±»å’Œå¤„ç†å™¨æ–¹æ³•çš„å¼•ç”¨æä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™è®©æˆ‘ä»¬æœ‰æœºä¼šåœ¨å®ˆå«æˆ–æ‹¦æˆªå™¨ä¸­è®¿é—®é€šè¿‡Â `Reflector#createDecorator`Â åˆ›å»ºçš„è£…é¥°å™¨æˆ–å†…ç½®Â `@SetMetadata()`Â è£…é¥°å™¨è®¾ç½®çš„å…ƒæ•°æ®ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹æ–‡ä¸­ä»‹ç»è¿™ä¸ªç”¨ä¾‹ã€‚

# åå°„ä¸å…ƒæ•°æ®
Nest æä¾›äº†é€šè¿‡Â `Reflector#createDecorator`Â æ–¹æ³•åˆ›å»ºçš„è£…é¥°å™¨ä»¥åŠå†…ç½®çš„Â `@SetMetadata()`Â è£…é¥°å™¨ï¼Œå°†è‡ªå®šä¹‰å…ƒæ•°æ®é™„åŠ åˆ°è·¯ç”±å¤„ç†ç¨‹åºçš„èƒ½åŠ›ã€‚æœ¬èŠ‚æˆ‘ä»¬å°†æ¯”è¾ƒè¿™ä¸¤ç§æ–¹æ³•ï¼Œå¹¶æ¢è®¨å¦‚ä½•åœ¨å®ˆå«æˆ–æ‹¦æˆªå™¨ä¸­è®¿é—®è¿™äº›å…ƒæ•°æ®ã€‚

è¦ä½¿ç”¨Â `Reflector#createDecorator`Â åˆ›å»ºå¼ºç±»å‹è£…é¥°å™¨ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šç±»å‹å‚æ•°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¥å—å­—ç¬¦ä¸²æ•°ç»„ä½œä¸ºå‚æ•°çš„Â `Roles`Â è£…é¥°å™¨ã€‚
```ts 
// roles.decorator.ts
import { Reflector } from '@nestjs/core';

export const Roles = Reflector.createDecorator<string[]>();
```
è¿™é‡Œçš„Â `Roles`Â è£…é¥°å™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç±»å‹ä¸ºÂ `string[]`Â çš„å•ä¸€å‚æ•°ã€‚

ç°åœ¨ï¼Œè¦ä½¿ç”¨è¿™ä¸ªè£…é¥°å™¨ï¼Œæˆ‘ä»¬åªéœ€ç”¨å®ƒæ¥æ³¨è§£å¤„ç†ç¨‹åºï¼š
```typescript
@Post()
@Roles(['admin'])
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```
æˆ‘ä»¬å·²å°†Â `Roles`Â è£…é¥°å™¨å…ƒæ•°æ®é™„åŠ åˆ°Â `create()`Â æ–¹æ³•ä¸Šï¼Œè¡¨æ˜åªæœ‰æ‹¥æœ‰Â `admin`Â è§’è‰²çš„ç”¨æˆ·æ‰è¢«å…è®¸è®¿é—®æ­¤è·¯ç”±ã€‚

è¦è®¿é—®è·¯ç”±çš„è§’è‰²ï¼ˆè‡ªå®šä¹‰å…ƒæ•°æ®ï¼‰ï¼Œæˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨Â `Reflector`Â è¾…åŠ©ç±»ã€‚Â `Reflector`Â å¯ä»¥é€šè¿‡å¸¸è§„æ–¹å¼æ³¨å…¥åˆ°ç±»ä¸­ï¼š
```typescript
@Injectable()
export class RolesGuard {
  constructor(private reflector: Reflector) {}
}
```
>ğŸ“Œæç¤º
>`Reflector`Â ç±»æ˜¯ä»Â `@nestjs/core`Â åŒ…ä¸­å¯¼å…¥çš„

ç°åœ¨ï¼Œè¦è¯»å–å¤„ç†ç¨‹åºçš„å…ƒæ•°æ®ï¼Œè¯·ä½¿ç”¨Â `get()`Â æ–¹æ³•ï¼š
```typescript
const roles = this.reflector.get(Roles, context.getHandler());
```
`Reflector#get`Â æ–¹æ³•å…è®¸æˆ‘ä»¬é€šè¿‡ä¼ å…¥ä¸¤ä¸ªå‚æ•°è½»æ¾è®¿é—®å…ƒæ•°æ®ï¼šä¸€ä¸ªè£…é¥°å™¨å¼•ç”¨å’Œä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆè£…é¥°å™¨ç›®æ ‡ï¼‰ä»¥ä»ä¸­æ£€ç´¢å…ƒæ•°æ®ã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼ŒæŒ‡å®šçš„è£…é¥°å™¨æ˜¯Â `Roles`Â ï¼ˆè¯·å‚è€ƒä¸Šæ–‡ä¸­çš„Â `roles.decorator.ts`Â æ–‡ä»¶ï¼‰ã€‚ä¸Šä¸‹æ–‡ç”±å¯¹Â `context.getHandler()`Â çš„è°ƒç”¨æä¾›ï¼Œä»è€Œæå–å½“å‰å¤„ç†çš„è·¯ç”±å¤„ç†ç¨‹åºçš„å…ƒæ•°æ®ã€‚è¯·è®°ä½ï¼ŒÂ `getHandler()`Â ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹è·¯ç”±å¤„ç†ç¨‹åºå‡½æ•°çš„å¼•ç”¨ã€‚

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å™¨çº§åˆ«åº”ç”¨å…ƒæ•°æ®ï¼Œä»è€Œå°†è¯¥é…ç½®åº”ç”¨äºæ§åˆ¶å™¨ç±»ä¸­çš„æ‰€æœ‰è·¯ç”±ã€‚
```typescript
@Roles(['admin'])
@Controller('cats')
export class CatsController {}
```
åœ¨æ­¤æƒ…å†µä¸‹ï¼Œä¸ºæå–æ§åˆ¶å™¨å…ƒæ•°æ®ï¼Œæˆ‘ä»¬å°†Â `context.getClass()`Â ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ï¼ˆä»¥æ§åˆ¶å™¨ç±»ä½œä¸ºå…ƒæ•°æ®æå–çš„ä¸Šä¸‹æ–‡ï¼‰ï¼Œè€Œéä½¿ç”¨Â `context.getHandler()`Â ï¼š
```typescript
const roles = this.reflector.get(Roles, context.getClass());
```
ç”±äºèƒ½å¤Ÿåœ¨å¤šä¸ªå±‚çº§æä¾›å…ƒæ•°æ®ï¼Œæ‚¨å¯èƒ½éœ€è¦ä»å¤šä¸ªä¸Šä¸‹æ–‡ä¸­æå–å¹¶åˆå¹¶å…ƒæ•°æ®ã€‚Â `Reflector`Â ç±»æä¾›äº†ä¸¤ä¸ªå®ç”¨æ–¹æ³•æ¥ååŠ©å®Œæˆæ­¤æ“ä½œã€‚è¿™äº›æ–¹æ³•èƒ½åŒæ—¶æå–æ§åˆ¶å™¨å’Œæ–¹æ³•çº§åˆ«çš„å…ƒæ•°æ®ï¼Œå¹¶ä»¥ä¸åŒæ–¹å¼å°†å®ƒä»¬ç»„åˆèµ·æ¥ã€‚

è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼Œæ‚¨å·²åœ¨ä¸¤ä¸ªå±‚çº§éƒ½æä¾›äº†Â `Roles`Â å…ƒæ•°æ®ã€‚
```typescript
@Roles(['user'])
@Controller('cats')
export class CatsController {
  @Post()
  @Roles(['admin'])
  async create(@Body() createCatDto: CreateCatDto) {
    this.catsService.create(createCatDto);
  }
}
```
å¦‚æœä½ çš„æ„å›¾æ˜¯å°†Â `'user'`Â æŒ‡å®šä¸ºé»˜è®¤è§’è‰²ï¼Œå¹¶é€‰æ‹©æ€§åœ°ä¸ºæŸäº›æ–¹æ³•è¦†ç›–å®ƒï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨Â `getAllAndOverride()`Â æ–¹æ³•ã€‚
```typescript
const roles = this.reflector.getAllAndOverride(Roles, [context.getHandler(), context.getClass()]);
```
è¿™æ®µä»£ç çš„å®ˆå«åœ¨Â `create()`Â æ–¹æ³•ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œç»“åˆä¸Šè¿°å…ƒæ•°æ®ï¼Œå°†å¯¼è‡´Â `roles`Â åŒ…å«Â `['admin']`Â ã€‚

è¦è·å–ä¸¤è€…çš„å…ƒæ•°æ®å¹¶è¿›è¡Œåˆå¹¶ï¼ˆæ­¤æ–¹æ³•ä¼šåˆå¹¶æ•°ç»„å’Œå¯¹è±¡ï¼‰ï¼Œè¯·ä½¿ç”¨Â `getAllAndMerge()`Â æ–¹æ³•ï¼š
```typescript
const roles = this.reflector.getAllAndMerge(Roles, [context.getHandler(), context.getClass()]);
```
è¿™å°†å¯¼è‡´Â `roles`Â åŒ…å«Â `['user', 'admin']`Â ã€‚

å¯¹äºè¿™ä¸¤ç§åˆå¹¶æ–¹æ³•ï¼Œæ‚¨éœ€è¦å°†å…ƒæ•°æ®é”®ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œå¹¶å°†å…ƒæ•°æ®ç›®æ ‡ä¸Šä¸‹æ–‡æ•°ç»„ï¼ˆå³å¯¹Â `getHandler()`Â å’Œ/æˆ–Â `getClass()`Â æ–¹æ³•çš„è°ƒç”¨ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ã€‚

#  åº•å±‚æ–¹æ³•
å¦‚å‰æ‰€è¿°ï¼Œé™¤äº†ä½¿ç”¨Â `Reflector#createDecorator`Â ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨å†…ç½®çš„Â `@SetMetadata()`Â è£…é¥°å™¨å°†å…ƒæ•°æ®é™„åŠ åˆ°å¤„ç†ç¨‹åºä¸Šã€‚
```typescript
@Post()
@SetMetadata('roles', ['admin'])
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```
>ğŸ“Œæç¤º
>`@SetMetadata()`Â è£…é¥°å™¨æ˜¯ä»Â `@nestjs/common`Â åŒ…ä¸­å¯¼å…¥çš„ã€‚

é€šè¿‡ä¸Šè¿°æ„å»ºï¼Œæˆ‘ä»¬å°†Â `roles`Â å…ƒæ•°æ®ï¼ˆÂ `roles`Â æ˜¯å…ƒæ•°æ®é”®ï¼ŒÂ `['admin']`Â æ˜¯å…³è”å€¼ï¼‰é™„åŠ åˆ°äº†Â `create()`Â æ–¹æ³•ä¸Šã€‚è™½ç„¶è¿™ç§æ–¹å¼å¯è¡Œï¼Œä½†ç›´æ¥åœ¨è·¯ç”±ä¸­ä½¿ç”¨Â `@SetMetadata()`Â å¹¶ä¸æ˜¯è‰¯å¥½çš„å®è·µã€‚ç›¸åï¼Œä½ å¯ä»¥åˆ›å»ºè‡ªå·±çš„è£…é¥°å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```typescript
import { SetMetadata } from '@nestjs/common';

export const Roles = (...roles: string[]) => SetMetadata('roles', roles);
```
è¿™ç§æ–¹å¼æ›´åŠ ç®€æ´æ˜“è¯»ï¼ŒæŸç§ç¨‹åº¦ä¸Šç±»ä¼¼äºÂ `Reflector#createDecorator`Â æ–¹æ¡ˆã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œä½¿ç”¨Â `@SetMetadata`Â æ—¶æ‚¨èƒ½æ›´çµæ´»åœ°æ§åˆ¶å…ƒæ•°æ®é”®å€¼ï¼Œè¿˜èƒ½åˆ›å»ºæ¥æ”¶å¤šä¸ªå‚æ•°çš„è£…é¥°å™¨ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†è‡ªå®šä¹‰çš„Â `@Roles()`Â è£…é¥°å™¨ï¼Œå°±å¯ä»¥ç”¨å®ƒæ¥è£…é¥°Â `create()`Â æ–¹æ³•äº†ã€‚
```typescript
@Post()
@Roles('admin')
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```
è¦è®¿é—®è·¯ç”±çš„è§’è‰²ï¼ˆè‡ªå®šä¹‰å…ƒæ•°æ®ï¼‰ï¼Œæˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨Â `Reflector`Â è¾…åŠ©ç±»ï¼š
```typescript
@Injectable()
export class RolesGuard {
  constructor(private reflector: Reflector) {}
}
```
>ğŸ“Œæç¤º
>`Reflector`Â ç±»æ˜¯ä»Â `@nestjs/core`Â åŒ…ä¸­å¯¼å…¥çš„

ç°åœ¨ï¼Œè¦è¯»å–å¤„ç†ç¨‹åºçš„å…ƒæ•°æ®ï¼Œè¯·ä½¿ç”¨Â `get()`Â æ–¹æ³•ã€‚
```typescript
const roles = this.reflector.get<string[]>('roles', context.getHandler());
```
è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä¼ é€’è£…é¥°å™¨å¼•ç”¨ï¼Œè€Œæ˜¯å°†å…ƒæ•°æ®é”®ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯Â `'roles'`Â ï¼‰ã€‚å…¶ä»–æ‰€æœ‰å†…å®¹éƒ½ä¸Â `Reflector#createDecorator`Â ç¤ºä¾‹ä¿æŒä¸€è‡´ã€‚
